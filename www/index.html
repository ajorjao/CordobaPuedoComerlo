<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
	<title>Menu</title>
	<link href="css/bootstrap.min.css"  rel="stylesheet">
    <link href="css/style.css"  rel="stylesheet">
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js" "></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <!-- <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script> -->
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript">

      var all_servers = ["192.168.2.8:3000","192.168.43.206:3000","10.6.43.164:3000","192.168.1.33:3000","192.168.2.7:3000","localhost:3000"];

      $(document).ready(function( $ ) {
        ping(all_servers.splice(0,1)[0]);
      });
      var url_server = ""
      var settings = {}
      function set_settings(url_server){
        settings = {
          "async": true,
          "crossDomain": true,
          "url": "http://"+url_server+"/ping",
          "method": "GET",
          "headers": {
            "cache-control": "no-cache",
            "postman-token": "4b2b1c69-8975-b182-c74e-f196b3ed57d3"
          },
          "timeout": 500
        }
      }

      function ping(url){
        set_settings(url);
        pings = $.ajax(settings);
        pings.done(function (response) {
          url_server = url;
          console.log("Conected to", url_server);
          get_my_data();
        })
        pings.fail(function (response) {
          console.log("fail", url);
          new_url = all_servers.splice(0,1)[0];
          if (new_url != undefined){
            ping(new_url);
          }
          else{
            alert("Problema de conexion con el servidor");
            location.reload();
          }
        })
      };



  	  function escanear(){
  	    cordova.plugins.barcodeScanner.scan(
  	      function (result) {
              get_product(result.text);
  	      },
  	      function (error) {
  	          alert("Scanning failed: " + error);
  	      },
  	      {
  	          "preferFrontCamera" : false, // iOS and Android
  	          "showFlipCameraButton" : true, // iOS and Android
  	          "prompt" : "Coloque el codigo de barra frente a la camara", // supported on Android only
  	          // default: all but PDF_417 and RSS_EXPANDED
  	          //"orientation" : "landscape" // Android only (portrait|landscape), default unset so it rotates with the device
  	      }
  	    );
  	  };

      function get_product(id){
        // $("#modal-popup").modal('show');
        // var request_ok = false;
        // var request_fail = false;

        var settings = {
          "async": true,
          "crossDomain": true,
          "url": "http://"+url_server+"/products/"+id,
          "headers": {
            "cache-control": "no-cache",
            "postman-token": "81b17c9b-b428-8799-911e-b183185f6434"
          },
          "method": "GET",
          error: function(resp, status){
            // alert("Error, por favor comprueba tu conexión")
            // console.log(resp)
            // alert(JSON.stringify(resp, null, 4));
            if (resp.status==0){
              alert("Error, por favor comprueba tu conexión")
            }
            else{
              alert(JSON.parse(resp.responseText).error)
            }
            // alert("Error, el producto no se encuentra disponible en nuestra base de datos.");
          }
        }

        $.ajax(settings).done(function (response) {
          alert(JSON.stringify(response, null, 4));
        });

      }

      function get_my_data(){
        var settings = {
          "async": true,
          "crossDomain": true,
          "url": "http://"+url_server+"/user",
          "method": "GET",
          xhrFields: {
            withCredentials: true
          },
          "headers": {
            "cache-control": "no-cache",
            "postman-token": "e75d6d1f-85a5-fdce-0ff6-704ff358920b"
          },
          error: function(resp, status){
            window.location = "login.html";
          }
        }

        $.ajax(settings).done(function (response) {
          var foto_de_perfil = "http://"+url_server+response.user.avatar_file_name
          $("#profilePicture").attr("src", foto_de_perfil);
        });
      }

      function go_profile(){
        window.location = "perfil.html";
      }

      function go_search_id(){
        window.location = "busqueda_id.html";
      }

      function go_search_name(){
        window.location = "busqueda_nombre.html";
      }

    </script>
</head>

<body>

<nav class="navbar">
  <div class="container-fluid">
    <ul class="nav navbar-nav">
    <li><a onClick="go_profile()"> <img id="profilePicture" alt="..." class="img-circle"></a></li>
    <li><p class="navbar-text navbar-text-menu">¿Puedo comerlo?</p></li>
    </ul>
  </div>
</nav>
  
  <div class="menu-wrapper">
  <div class="row">
    <div class="col-xs-12 ">
      <button onClick="escanear()" type="button" class="btn btn-default btn-lg btn-block">
          
          <img  src="img/barcode-search.png" alt="..." >
          <br>
          <p>Escanear Producto</p>    
      </button>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-6 ">
      <button type="button" onClick="go_search_name()" class="btn btn-default btn-lg btn-block">
        <span class="glyphicon glyphicon-search aria-hidden="true"></span>
        Buscar por nombre
      </button>
    </div>
    <div class="col-xs-6 ">
      <button type="button" onClick="go_search_id()" class="btn btn-default btn-lg btn-block">
        <span class="glyphicon glyphicon-barcode aria-hidden="true"></span>
        Buscar por código
      </button>
    </div>   
  </div>
    <div class="row">
    <div class="col-xs-12 ">
      <button  type="button" class="btn btn-default btn-lg btn-block" data-toggle="modal" data-target="#contacto-modal">
      <span class="glyphicon glyphicon-send aria-hidden="true"></span>
      Contactanos</button>
    </div>
  </div>
  </div>

    <!-- Modal -->
    <div class="modal fade" id="contacto-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Contacto</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal">
                <div class="form-group">
                  <label for="text" class="col-sm-2 control-label">Nombre</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" id="name" placeholder="Nombre">
                  </div>
                </div>
                <div class="form-group">
                  <label for="inputEmail3" class="col-sm-2 control-label">Email</label>
                  <div class="col-sm-10">
                    <input type="email" class="form-control" id="inputEmail3" placeholder="Email">
                  </div>
                </div>
                <div class="form-group">
                  <label for="message" class="col-sm-2 control-label">Mensaje</label>
                  <div class="col-sm-10">
                    <textarea id="message" class="form-control" rows="3"></textarea>
                  </dir>
                </div>
                
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-primary">Enviar</button>
          </div>
          </form>
        </div>
      </div>
    </div>
</body>
</html>